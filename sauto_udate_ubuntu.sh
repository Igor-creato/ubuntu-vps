#!/bin/bash
# setup.sh ‚Äì –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π, –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
set -e

# --- –ó–∞–ø—Ä–æ—Å Telegram-–¥–∞–Ω–Ω—ã—Ö ---
read -rp "–í–≤–µ–¥–∏—Ç–µ Telegram Bot Token: " BOT_TOKEN
read -rp "–í–≤–µ–¥–∏—Ç–µ Telegram Chat ID:   " CHAT_ID
[[ -z "$BOT_TOKEN" || -z "$CHAT_ID" ]] && { echo "–û–±–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã!"; exit 1; }

# --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤ ---
echo "[*] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤ –ø–∞–∫–µ—Ç–æ–≤..."
apt-get update -qq
echo "[*] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ unattended-upgrades curl..."
apt-get install -y -qq unattended-upgrades curl

# --- –í–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–π ---
echo "[*] –í–∫–ª—é—á–µ–Ω–∏–µ unattended-upgrades..."
echo 'unattended-upgrades unattended-upgrades/enable_auto_updates boolean true' \
  | debconf-set-selections
dpkg-reconfigure -f noninteractive unattended-upgrades

# --- –°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ ---
SCRIPT_PATH="/usr/local/bin/check_reboot_and_notify.sh"
cat > "$SCRIPT_PATH" <<EOF
#!/bin/bash
BOT_TOKEN="$BOT_TOKEN"
CHAT_ID="$CHAT_ID"
if [ -f /var/run/reboot-required ]; then
    curl -s -X POST "https://api.telegram.org/bot\${BOT_TOKEN}/sendMessage" \
         -d chat_id="\${CHAT_ID}" \
         -d text="üîÅ –°–µ—Ä–≤–µ—Ä \$(hostname) —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π." >/dev/null
fi
EOF
chmod +x "$SCRIPT_PATH"

# --- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ cron (–±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è) ---
CRON_JOB="*/30 * * * * $SCRIPT_PATH"
(crontab -l 2>/dev/null | grep -v "$SCRIPT_PATH"; echo "$CRON_JOB") | crontab -

# --- –ü–µ—Ä–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ ---
echo "[*] –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏..."
"$SCRIPT_PATH"

echo "[‚úÖ] –ì–æ—Ç–æ–≤–æ! –ü—Ä–æ–≤–µ—Ä–∫–∞ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç."
